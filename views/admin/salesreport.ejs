<!DOCTYPE HTML>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:title" content="">
    <meta property="og:type" content="">
    <meta property="og:url" content="">
    <meta property="og:image" content="">
    <title>FURNIX Admin</title>
    <link rel="shortcut icon" type="image/x-icon" href="/admin-assets/imgs/theme/favicon-16x16.png">
    <link href="/admin-assets/css/main.css" rel="stylesheet" type="text/css" />
</head>
<style>
    .custom-button1 {
        width: 120px;
        height: 100%;
        padding: 5px;
        background-color: rgb(255, 255, 255);
        color: rgb(0, 0, 0);
        font-size: 14px;
        border:  1px solid black;
        margin-left: -10px;
        border-radius: 5px;
    }
    .excelbtn {
        width: 160px;
        height: 100%;
        background-color: rgb(0, 136, 86);
        color: rgb(255, 255, 255);
        font-size: 14px;
        border-radius: 5px;
    }
    .pdfbtn {
        width: 150px;
        height: 100%;
        background-color: rgb(162, 0, 0);
        color: rgb(255, 255, 255);
        font-size: 14px;
        border-radius: 5px;
    }
    .custom-button1:hover{
        background-color: rgb(213, 213, 213);
        color: rgb(0, 0, 0);
    }
    .custom-select {
    background-color: black;
    color: white;
    width: 150px;
    height: 40px;
    border-radius: 5px;
    z-index: 1;
}
input[type="date"]::-webkit-calendar-picker-indicator {
    filter: invert(1);
}

</style>
<body>
    <div class="screen-overlay"></div>
    <aside class="navbar-aside" id="offcanvas_aside">
        <div class="aside-top">
            <a href="index.html" class="brand-wrap">
                <img src="/admin-assets/imgs/theme/logo.png" class="logo" alt="Evara Dashboard">
            </a>
            <div>
                <button class="btn btn-icon btn-aside-minimize"> <i class="text-muted material-icons md-menu_open"></i> </button>
            </div>
        </div>
        <nav>
            <ul class="menu-aside">
                <li class="menu-item">
                    <a class="menu-link" href="/admin/adminHome"> <i class="icon material-icons md-home"></i>
                        <span class="text">Dashboard</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a class="menu-link" href="/admin/adminUserList"> <i class="icon material-icons md-person"></i>
                        <span class="text">Users</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a class="menu-link" href="/admin/category"> <i class="icon material-icons md-shopping_bag"></i>
                        <span class="text">Category</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a class="menu-link" href="/admin/productPage"> <i class="icon material-icons md-stars"></i>
                        <span class="text">Product</span> </a>
                </li>
                <li class="menu-item ">
                    <a class="menu-link" href="/admin/order"> <i class="icon material-icons md-shopping_cart"></i>
                        <span class="text">Orders</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a class="menu-link" href="/admin/coupon"> <i class="icon material-icons md-local_offer"></i>
                        <span class="text">Coupons</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a class="menu-link  btn-dark text-light"> <i class="icon material-icons md-monetization_on"></i>
                        <span class="text">Sales report</span>
                    </a>
                </li>
            </ul>
        </nav>
    </aside>
    <main class="main-wrap">
        <header class="main-header navbar">
            <div class="col-search">
                <form class="searchform">
                    <div class="input-group">
                        <input list="search_terms" type="text" class="form-control" placeholder="Search term">
                    </div>
                </form>
            </div>
            <div class="col-nav">
                <button class="btn btn-icon btn-mobile me-auto" data-trigger="#offcanvas_aside"> <i
                        class="material-icons md-apps"></i> </button>
                <ul class="nav">
                    <li class="dropdown nav-item">
                        <a class="dropdown-toggle" data-bs-toggle="dropdown" href="#" id="dropdownAccount"
                            aria-expanded="false"> <img class="img-xs rounded-circle"
                                src="/admin-assets/imgs/people/profile.jpg" alt="User"></a>
                        <div class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownAccount">
                            <a class="dropdown-item text-danger" href="/admin/adminLogout"><i
                                    class="material-icons md-exit_to_app"></i>Logout</a>
                        </div>
                    </li>
                </ul>
            </div>
        </header>
        <section class="content-main">
            <div class="content-header">
                <h2 class="content-title fw-bold" style="margin: auto;">Sales report</h2>
            </div>
            <div class="card mb-4">
                <header class="card-header">
                    <div class="row gx-3">
                        <div class="col-lg-2 col-6 col-md-3 d-flex align-items-center">
                            <select class="custom-select" id="selectvalue">
                                <option>All</option>
                                <option>Today</option>
                                <option>Month</option>
                                <option>Year</option>
                            </select>                            
                            <button class="custom-button1" onclick="select()">Search</button>
                        </div>
                        <div class="col-lg-3 col-6 col-md-3 d-flex align-items-center">
                            <% if (customValue) { %>
                                <input type="date" class="custom-select" id="customdate" value="<%= customValue %>">                           
                            <% } else { %>
                                <input type="date" class="custom-select" id="customdate"> 
                            <% } %>
                            <button class="custom-button1" onclick="customdate()">Search</button>
                        </div>
                        <% if (deliveredOrders.length !=0) { %>
                            <div class="col-lg-7 col-md-6 d-flex justify-content-end align-items-center" style="gap: 15px;">
                                <button class="pdfbtn" onclick="generatePDF('pdf')"><svg xmlns="http://www.w3.org/2000/svg" height="23" width="23" viewBox="0 0 512 512"><path fill="#ffffff" d="M0 64C0 28.7 28.7 0 64 0L224 0l0 128c0 17.7 14.3 32 32 32l128 0 0 144-208 0c-35.3 0-64 28.7-64 64l0 144-48 0c-35.3 0-64-28.7-64-64L0 64zm384 64l-128 0L256 0 384 128zM176 352l32 0c30.9 0 56 25.1 56 56s-25.1 56-56 56l-16 0 0 32c0 8.8-7.2 16-16 16s-16-7.2-16-16l0-48 0-80c0-8.8 7.2-16 16-16zm32 80c13.3 0 24-10.7 24-24s-10.7-24-24-24l-16 0 0 48 16 0zm96-80l32 0c26.5 0 48 21.5 48 48l0 64c0 26.5-21.5 48-48 48l-32 0c-8.8 0-16-7.2-16-16l0-128c0-8.8 7.2-16 16-16zm32 128c8.8 0 16-7.2 16-16l0-64c0-8.8-7.2-16-16-16l-16 0 0 96 16 0zm80-112c0-8.8 7.2-16 16-16l48 0c8.8 0 16 7.2 16 16s-7.2 16-16 16l-32 0 0 32 32 0c8.8 0 16 7.2 16 16s-7.2 16-16 16l-32 0 0 48c0 8.8-7.2 16-16 16s-16-7.2-16-16l0-64 0-64z"/></svg> &nbsp;&nbsp;Download PDF</button>
                                <button class="excelbtn" onclick="generatePDF('excel')"><svg xmlns="http://www.w3.org/2000/svg" height="23" width="23" viewBox="0 0 384 512"><path fill="#ffffff" d="M64 0C28.7 0 0 28.7 0 64V448c0 35.3 28.7 64 64 64H320c35.3 0 64-28.7 64-64V160H256c-17.7 0-32-14.3-32-32V0H64zM256 0V128H384L256 0zM155.7 250.2L192 302.1l36.3-51.9c7.6-10.9 22.6-13.5 33.4-5.9s13.5 22.6 5.9 33.4L221.3 344l46.4 66.2c7.6 10.9 5 25.8-5.9 33.4s-25.8 5-33.4-5.9L192 385.8l-36.3 51.9c-7.6 10.9-22.6 13.5-33.4 5.9s-13.5-22.6-5.9-33.4L162.7 344l-46.4-66.2c-7.6-10.9-5-25.8 5.9-33.4s25.8-5 33.4 5.9z"/></svg> &nbsp;&nbsp;Download EXCEL</button>
                            </div>
                        <% } %>
                    </div>
                    <p style="color: red; margin-top: 20px; text-align: center;" id="custmerror"></p>
                </header>
                
                
                <div class="card-body">
                    <% if (deliveredOrders.length !=0) { %>
                        <div class="table-responsive">
                            <table class="table table-hover" id="sales-table" style="border-collapse: collapse; width: 100%; border: 1px solid black;">
                                <thead class="text-center" style="background-color: black; color: white;">
                                    <tr>
                                        <th>OrderID</th>
                                        <th scope="col">Email</th>
                                        <th scope="col">Total</th>
                                        <th scope="col">Delivered date</th>
                                        <th scope="col">Coupon code</th>
                                        <th scope="col">Coupon discount</th>
                                        <th scope="col">Payment method</th>
                                    </tr>
                                </thead>
                                <tbody class="text-center">
                                    <% for( let i = 0; i < deliveredOrders.length; i++ ) { %>
                                        <tr style="border-bottom: 1px solid black;">
                                            <td><%= deliveredOrders[i].orderID %></td>
                                            <td><%= deliveredOrders[i].userEmail %></td>
                                            <td>₹<%= deliveredOrders[i].total %></td>
                                            <td><%= deliveredOrders[i].deliveredDateTime %></td>
                                            <td>
                                                <% if (deliveredOrders[i].couponCode === "false") { %>
                                                    Not used
                                                <% } else { %>
                                                    <%= deliveredOrders[i].couponCode %>
                                                <% } %>
                                            </td>
                                            <td>
                                                <% if (deliveredOrders[i].couponCode === "false") { %>
                                                    Not used
                                                <% } else { %>
                                                    ₹<%= deliveredOrders[i].couponOffer %>
                                                <% } %>
                                            </td>
                                            <td><%= deliveredOrders[i].paymentMethod %></td>
                                        </tr>
                                    <% } %>
                                </tbody>
                            </table>
                        </div>
                        
                        
                    <% } else { %>
                        <h5>No orders found </h5>
                    <% } %>

                    <!-- Total table-->
                    <div class="table-responsive col-lg-4" style="margin-top: 40px;">
                        <table class="table table-hover" style="border-collapse: collapse; width: 100%; border: 1px solid black;">
                            <thead class="text-center" style="background-color: black; color: white;">
                                <tr>
                                    <th colspan="2">Overall sales summary</th>
                                </tr>
                            </thead>
                            <tbody class="text-center">
                                <tr>
                                    <td style="border-bottom: 1px solid black;">Total sales</td>
                                    <td style="border-bottom: 1px solid black;"><%= deliveredOrders.length %></td>
                                </tr>
                                <tr>
                                    <% let totalAmount = 0 %>
                                    <% if (deliveredOrders.length > 0) { %>
                                        <% for( let i = 0; i < deliveredOrders.length; i++ ) { %>
                                            <% totalAmount += deliveredOrders[i].subTotal %>
                                        <% } %>
                                    <% } %>
                                    <td style="border-bottom: 1px solid black;">Total amount</td>
                                    <td style="border-bottom: 1px solid black;">₹<%= totalAmount %></td>
                                </tr>                                
                                <tr>
                                    <% let offerAmount = 0 %>
                                    <% if (deliveredOrders.length > 0) { %>
                                        <% for( let i = 0; i < deliveredOrders.length; i++ ) { %>
                                            <% offerAmount += deliveredOrders[i].couponOffer %>
                                        <% } %>
                                    <% } %>
                                    <td style="border-bottom: 1px solid black;">Total discount</td>
                                    <td style="border-bottom: 1px solid black;">₹<%= offerAmount %></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                </div>
            </div>
        </section> 
    </main>
    <script src="/admin-assets/js/vendors/jquery-3.6.0.min.js"></script>
    <script src="/admin-assets/js/vendors/bootstrap.bundle.min.js"></script>
    <script src="/admin-assets/js/vendors/select2.min.js"></script>
    <script src="/admin-assets/js/vendors/perfect-scrollbar.js"></script>
    <script src="/admin-assets/js/vendors/jquery.fullscreen.min.js"></script>
    <script src="/admin-assets/js/vendors/chart.js"></script>
    <script src="/admin-assets/js/main.js" type="text/javascript"></script>
    <script src="/admin-assets/js/custom-chart.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>

</body>
<script>
    function select(){
        const value = document.getElementById("selectvalue").value;
        window.location.href= `/admin/salesreport?value=${value}`
    }

    function customdate() {
        const customdateValue = document.getElementById("customdate").value;
        const today = new Date();
        if (!customdateValue) {
            document.getElementById("custmerror").textContent = "Please select a date"
            setTimeout(() => {
                document.getElementById("custmerror").textContent = ""
            }, 2000);
        } else {
            const customdate = new Date(customdateValue);
            if (customdate >= today) {
                document.getElementById("custmerror").textContent = "You can only view today's or previous day's orders"
                setTimeout(() => {
                    document.getElementById("custmerror").textContent = ""
                }, 2000);
            } else {
                window.location.href= `/admin/salesreport?value=${customdateValue}`
            }
        }
    }

    function generatePDF(type) {
    const downloadData = document.querySelector(".card-body");
    if (type === 'pdf') {
        html2pdf().from(downloadData).save();
    } else if (type === 'excel') {
        
        const salesTable = document.getElementById("sales-table")
        const tableData = salesTable.querySelector("tbody");
        const salesDataArray = [];

        for (let row of tableData.rows) {
            let orderId = row.cells[0] ? row.cells[0].textContent.trim() : '';
            let email = row.cells[1] ? row.cells[1].textContent.trim() : '';
            let total = row.cells[2] ? row.cells[2].textContent.trim() : '';
            let DeliDate = row.cells[3] ? row.cells[3].textContent.trim() : '';
            let couponcode = row.cells[4] ? row.cells[4].textContent.trim() : '';
            let coupondiscount = row.cells[5] ? row.cells[5].textContent.trim() : '';
            let paymentMethod = row.cells[6] ? row.cells[6].textContent.trim() : '';
            let data = {
                orderID: orderId,
                customerEmail: email,
                total: total,
                deliveredDate: DeliDate,
                couponcode: couponcode,
                coupondiscount: coupondiscount,
                paymentMethod: paymentMethod
            };
            salesDataArray.push(data);
        }

        try {
            const response = fetch('/admin/excelDownload', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ salesDataArray })
            })

            .then(response => {
                if (response.ok) {
                    return response.blob();
                } else {
                    throw new Error('Failed to download Excel file');
                }
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'report.xlsx';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            })
        } catch (error) {
            console.error('Error fetching data:', error);
        }
    }
}


</script>
</html>